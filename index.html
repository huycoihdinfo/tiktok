<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SƒÉn K√®o Vercel</title>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Th√¥ng tin User */
        .user-name {
            color: #fe2c55;
            font-size: 1.8rem;
            font-weight: bold;
            text-decoration: none;
            margin-bottom: 5px;
        }
        .stats {
            color: #888;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        /* ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c */
        .countdown-box {
            font-size: 4rem;
            font-weight: bold;
            font-family: monospace;
            padding: 20px 40px;
            border-radius: 12px;
            background: #1e1e1e;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            min-width: 300px;
            text-align: center;
            border: 2px solid #333;
            transition: all 0.1s;
        }
        .green-mode { color: #00ff00; border-color: #00ff00; }
        .red-mode { color: #ff0000; border-color: #ff0000; background: #fff; }

        /* N√∫t Ch·ªânh Delay (Delta) */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }
        .btn-adj {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            font-size: 1rem;
        }
        .btn-minus { background: #dc3545; }
        .btn-plus { background: #28a745; }
        .delta-display { font-family: monospace; font-size: 1.2rem; min-width: 80px; text-align: center;}

        /* N√∫t M·ªü App */
        .claim-btn {
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            margin-top: 30px;
            padding: 15px 50px;
            background-color: #fe2c55;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            border-radius: 50px;
            box-shadow: 0 0 20px rgba(254, 44, 85, 0.6);
            animation: pulse 0.8s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .sync-status {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.8rem;
            color: #555;
        }
    </style>
</head>
<body>

    <div class="sync-status" id="syncStatus">üì° ƒêang k·∫øt n·ªëi Vercel...</div>

    <a id="userLink" class="user-name" href="#" target="_blank">Loading...</a>
    <div id="stats" class="stats">...</div>

    <div id="timer" class="countdown-box">Wait...</div>

    <a id="claimBtn" href="#" class="claim-btn">M·ªû TIKTOK</a>

    <div class="controls">
        <button class="btn-adj btn-minus" onclick="adjustDelta(-50)">-0.05</button>
        <button class="btn-adj btn-minus" onclick="adjustDelta(-10)">-0.01</button>
        <span id="deltaText" class="delta-display">0.00s</span>
        <button class="btn-adj btn-plus" onclick="adjustDelta(10)">+0.01</button>
        <button class="btn-adj btn-plus" onclick="adjustDelta(50)">+0.05</button>
    </div>

    <script>
        // ============================================
        // 1. C·∫§U H√åNH & BI·∫æN TO√ÄN C·ª§C
        // ============================================
        let serverTimeOffset = 0; // ƒê·ªô l·ªách gi·ªù Server (ms)
        let isSynced = false;
        
        // L·∫•y delta ch·ªânh tay t·ª´ localStorage (ƒë·ªÉ F5 kh√¥ng m·∫•t)
        let manualDelta = parseFloat(localStorage.getItem('my_delta') || '0'); 
        updateDeltaUI();

        // ============================================
        // 2. LOGIC ƒê·ªíNG B·ªò GI·ªú (VERCEL API)
        // ============================================
        async function syncWithVercel() {
            try {
                const statusEl = document.getElementById('syncStatus');
                const z = Math.floor(Math.random() * 50) + 50; // Random z 50-100
                const t1 = performance.now();

                // G·ªçi API Serverless c·ªßa ch√≠nh m√¨nh
                // L∆∞u √Ω: ƒê∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi /api/ping ƒë·ªÉ ch·∫°y tr√™n Vercel
                const response = await fetch(`/api/ping?z=${z}`);
                const encodedText = await response.text();
                const t2 = performance.now();

                // GI·∫¢I M√É (Logic Junb)
                // ASCII - 1 - 2z
                const serverTimeStr = encodedText.split('').map(char => {
                    return String(char.charCodeAt(0) - 1 - (2 * z));
                }).join('');
                
                const serverTimeMs = parseInt(serverTimeStr);

                if (isNaN(serverTimeMs)) throw new Error("L·ªói gi·∫£i m√£");

                // T√≠nh to√°n Offset (NTP Algorithm ƒë∆°n gi·∫£n h√≥a)
                const rtt = t2 - t1;
                const clientTimeNow = Date.now();
                // Gi·ªù server ∆∞·ªõc t√≠nh t·∫°i th·ªùi ƒëi·ªÉm nh·∫≠n g√≥i tin
                const estimatedServerTime = serverTimeMs + (rtt / 2);
                
                serverTimeOffset = estimatedServerTime - clientTimeNow;
                isSynced = true;

                statusEl.innerHTML = `‚úÖ ƒê√£ Sync Vercel (RTT: ${rtt.toFixed(0)}ms)`;
                statusEl.style.color = '#0f0';
                console.log(`Sync Success: Offset=${serverTimeOffset.toFixed(2)}ms, RTT=${rtt.toFixed(2)}ms`);

            } catch (e) {
                console.error("Sync Failed:", e);
                document.getElementById('syncStatus').innerHTML = `‚ö†Ô∏è D√πng gi·ªù m√°y t√≠nh (Sync l·ªói)`;
                // V·∫´n cho ch·∫°y ti·∫øp b·∫±ng gi·ªù m√°y t√≠nh (offset = 0)
            }
        }

        // Sync ngay khi m·ªü v√† l·∫∑p l·∫°i m·ªói 10s
        syncWithVercel();
        setInterval(syncWithVercel, 10000);

        // ============================================
        // 3. X·ª¨ L√ù URL PARAMS
        // ============================================
        const params = new URLSearchParams(window.location.search);

        // L·∫•y th√¥ng tin t·ª´ URL (t·ª´ tool Python)
        const username = params.get('username') || 'Unknown';
        const targetTimeSec = parseInt(params.get('time') || '0'); 
        const targetTimeMs = targetTimeSec * 1000;
        
        const matxem = params.get('matxem') || params.get('view') || '0';
        const people = params.get('people') || '0';
        const openLink = params.get('opentiktok') || '#';

        // Render th√¥ng tin tƒ©nh
        document.getElementById('userLink').textContent = `@${username}`;
        document.getElementById('userLink').href = `https://www.tiktok.com/@${username}`;
        document.getElementById('stats').textContent = `üëÅÔ∏è ${matxem} ƒëang xem | üéÅ ${people} su·∫•t`;
        document.getElementById('claimBtn').href = openLink;

        // ============================================
        // 4. V√íNG L·∫∂P ƒê·∫æM NG∆Ø·ª¢C (CORE)
        // ============================================
        const timerEl = document.getElementById('timer');
        const claimBtn = document.getElementById('claimBtn');
        let isFinished = false;

        function updateTimer() {
            // Gi·ªù hi·ªán t·∫°i = Gi·ªù m√°y + Offset Server
            const now = Date.now() + serverTimeOffset;

            // Th·ªùi gian c√≤n l·∫°i = ƒê√≠ch - (Hi·ªán t·∫°i - Ch·ªânh tay)
            // manualDelta d∆∞∆°ng (+) nghƒ©a l√† mu·ªën ƒë·ªìng h·ªì ch·∫°y nhanh h∆°n (gi·∫£m th·ªùi gian c√≤n l·∫°i)
            // manualDelta √¢m (-) nghƒ©a l√† mu·ªën ƒë·ªìng h·ªì ch·∫°y ch·∫≠m l·∫°i (tƒÉng th·ªùi gian c√≤n l·∫°i)
            const remainingMs = targetTimeMs - (now - manualDelta);
            const remainingSec = remainingMs / 1000;

            if (remainingSec <= 0) {
                // H·∫æT GI·ªú
                timerEl.textContent = "0.00";
                timerEl.classList.remove('green-mode');
                timerEl.classList.add('red-mode'); // Chuy·ªÉn m√†u ƒë·ªè/tr·∫Øng
                timerEl.style.color = '#000'; // Ch·ªØ ƒëen n·ªÅn tr·∫Øng cho d·ªÖ nh√¨n l√∫c ch·ªõp

                if (!isFinished) {
                    claimBtn.style.display = "inline-block"; // Hi·ªán n√∫t
                    // T·ª± ƒë·ªông m·ªü link n·∫øu mu·ªën (b·ªè comment d√≤ng d∆∞·ªõi)
                    // window.location.href = openLink; 
                    isFinished = true;
                }
                return;
            }

            // C√íN GI·ªú
            timerEl.textContent = remainingSec.toFixed(2);
            timerEl.classList.add('green-mode');
        }

        // Ch·∫°y update m·ªói 20ms (50fps)
        setInterval(updateTimer, 20);

        // ============================================
        // 5. C√ÅC H√ÄM TI·ªÜN √çCH
        // ============================================
        function adjustDelta(val) {
            manualDelta += val;
            localStorage.setItem('my_delta', manualDelta);
            updateDeltaUI();
        }

        function updateDeltaUI() {
            const sec = manualDelta / 1000;
            const el = document.getElementById('deltaText');
            el.innerHTML = `<b>${sec > 0 ? '+' : ''}${sec.toFixed(2)}s</b>`;
            el.style.color = sec === 0 ? '#fff' : (sec > 0 ? '#28a745' : '#dc3545');
        }
        
        // Fix l·ªói click link tr√™n mobile
        claimBtn.addEventListener('click', (e) => {
            // Force m·ªü link
            setTimeout(() => {
                window.location.href = openLink;
            }, 100);
        });

    </script>
</body>
</html>
